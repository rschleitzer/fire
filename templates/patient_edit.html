{% extends "base.html" %}

{% block title %}Edit Patient - Fire Server{% endblock %}

{% block extra_head %}
<script src="/static/js/fhir-components.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Patient</h2>
    <div id="patient-editor"></div>
</div>

<script>
    // Patient resource data from server
    const resource = {{ resource_json|safe }};

    // Mount the Svelte Patient component
    const editor = new FHIRComponents.Patient({
        target: document.getElementById('patient-editor'),
        props: { resource }
    });

    // Listen for save event from the editor
    window.addEventListener('save', async (event) => {
        const updated = event.detail;
        const isNew = !('{{ id }}') || '{{ id }}' === '';

        try {
            const url = isNew ? '/fhir/Patient' : '/fhir/Patient/{{ id }}';
            const method = isNew ? 'POST' : 'PUT';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/fhir+json',
                    'Accept': 'application/fhir+json'
                },
                body: JSON.stringify(updated)
            });

            if (response.ok) {
                const result = await response.json();
                // Success - navigate to detail view
                // For new resources, use the ID from the response
                const resourceId = result.id || '{{ id }}';
                window.location.href = '/fhir/Patient/' + resourceId;
            } else {
                // Error - parse and display
                const error = await response.json();
                window.dispatchEvent(new CustomEvent('save-error', {
                    detail: {
                        message: error.issue?.[0]?.diagnostics ||
                                error.diagnostics ||
                                'Failed to save patient'
                    }
                }));
            }
        } catch (err) {
            window.dispatchEvent(new CustomEvent('save-error', {
                detail: { message: 'Network error: ' + err.message }
            }));
        }
    });
</script>
{% endblock %}
