{% extends "base.html" %}

{% block title %}Edit Observation - Fire Server{% endblock %}

{% block extra_head %}
<script src="/static/js/fhir-components.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Observation</h2>
    <div id="observation-editor"></div>
</div>

<script>
    // Observation resource data from server
    const resource = {{ resource_json|safe }};

    // Mount the Svelte Observation component
    const editor = new FHIRComponents.Observation({
        target: document.getElementById('observation-editor'),
        props: { resource }
    });

    // Listen for save event from the editor
    window.addEventListener('save', async (event) => {
        const updated = event.detail;
        const isNew = !('{{ id }}') || '{{ id }}' === '';

        try {
            const url = isNew ? '/fhir/Observation' : '/fhir/Observation/{{ id }}';
            const method = isNew ? 'POST' : 'PUT';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/fhir+json',
                    'Accept': 'application/fhir+json'
                },
                body: JSON.stringify(updated)
            });

            if (response.ok) {
                const result = await response.json();
                // Success - navigate to detail view
                // For new resources, use the ID from the response
                const resourceId = result.id || '{{ id }}';
                window.location.href = '/fhir/Observation/' + resourceId;
            } else {
                // Error - parse and display
                const error = await response.json();
                window.dispatchEvent(new CustomEvent('save-error', {
                    detail: {
                        message: error.issue?.[0]?.diagnostics ||
                                error.diagnostics ||
                                'Failed to save observation'
                    }
                }));
            }
        } catch (err) {
            window.dispatchEvent(new CustomEvent('save-error', {
                detail: { message: 'Network error: ' + err.message }
            }));
        }
    });
</script>
{% endblock %}
